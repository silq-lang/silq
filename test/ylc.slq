// Yoder‚ÄìLow‚ÄìChuang

def acot(x: !‚Ñù): !‚Ñù ‚áí atan2(1, x);

// Hadamards on all n qubits
def H_n[n:!‚Ñï](xs: uint[n]) {
	for i in 0..n { xs[i] := H(xs[i]); }
	return xs;
}

// Generalized reflection about |s> = H_n|0‚Ä¶0‚ü© with phase Œ∏:
// S_s(Œ∏) = I - (1 - e^{iŒ∏})|s‚ü©‚ü®s| = H_n ¬∑ (phase Œ∏ on |0‚Ä¶0‚ü©) ¬∑ H_n
def S_s[n:!‚Ñï](cand: uint[n], Œ∏: !‚Ñù) {
	with cand := H_n(cand) do
		if cand == 0 { phase(Œ∏); }
	return cand;
}

// Generalized reflection about the marked subspace with phase Œ∏:
// S_t(Œ∏) = I - (1 - e^{iŒ∏}) Œ†_œâ
def S_t[n:!‚Ñï](cand: uint[n], const f: const uint[n] ‚Üí lifted ùîπ, Œ∏: !‚Ñù) {
	if f(cand) { phase(Œ∏); }
	return cand;
}

// build Œ±,Œ≤ from L,Œ¥
def ylc_Œ±Œ≤(L: !‚Ñï, Œ¥: !‚Ñù) : !‚Ñù^(L div 2) x !‚Ñù^(L div 2){
	assert(L % 2 == 1);
	‚Ñì := L div 2;
	œÅ := tanh(acosh(1/Œ¥)/L);
	(Œ±,Œ≤) := vector(2,vector(‚Ñì, 0));
	for j in 0..‚Ñì {
		Œ∏ := 2¬∑œÄ¬∑(j+1)/L;
		Œ≤[j] = 2¬∑atan2(cos(Œ∏),œÅ¬∑sin(Œ∏));
		Œ±[‚Ñì-1-j] = Œ≤[j];
	}
	return (Œ± coerce !‚Ñù^(L div 2), Œ≤ coerce !‚Ñù^(L div 2));
}

// fixed-point AA
def ylc_fixed_point[n:!‚Ñï](const f: const uint[n] ‚Üí lifted ùîπ, L: !‚Ñï, Œ¥: !‚Ñù) {
	assert(L % 2 == 1);
	cand := H_n(0:uint[n]);
	(Œ±, Œ≤) := ylc_Œ±Œ≤(L, Œ¥);
	for j in 0..L div 2 {
		cand := S_s(cand, Œ±[j]);
		cand := S_t(cand, f, Œ≤[j]);
	}
	return cand;
}

def ylc_staged_heralded[n:!‚Ñï](const f: const uint[n] ‚Üí lifted ùîπ) {
	j := 0;
	L := 3;
	while true{
		j += 1;
		if j > 1 {
			if L=3 { L=5; }
			else   { L=2*L sub 1; }
		}
		Œ¥ := 1/(j+5);
		cand := ylc_fixed_point(f, L, Œ¥);
		if measure(f(cand)) { return cand; }
		measure(cand);
	}
}

// Choose an odd L >= 3 for YLC given Œª‚ãÜ‚â§M/N and target Œ¥ in (0,1).
def ylc_choose_L_asymp(Œª_star, Œ¥:!‚Ñù):!‚Ñï {
	assert(0 < Œª_star && Œª_star ‚â§ 1);
	assert(0 < Œ¥ && Œ¥ < 1);
	L := ceil(acosh(1/Œ¥)/sqrt(Œª_star)) coerce !‚Ñï;
	if L<3 { L=3; }
	if L%2=0 { L+=1; }
	return L;
}
def ylc_choose_L_exact(Œª_star:!‚Ñù,Œ¥:!‚Ñù):!‚Ñï{
    L := 3;
    while true {
        z := acosh(1/Œ¥)/L;
        œÅ := tanh(z);
        w := œÅ^2;
        if w ‚â§ Œª_star { return L; }
        L += 2;
    }
}
def ylc_choose_L(Œª_star:!‚Ñù,Œ¥:!‚Ñù):!‚Ñï{
	a:=acosh(1/Œ¥);
	def ok(L: !‚Ñï)‚áí tanh(a/L)^2 ‚â§ (1-1e-6)¬∑Œª_star;
    (‚Ñì_lo,‚Ñì_hi) := (0,1);
	while !ok(2¬∑‚Ñì_hi+1){ ‚Ñì_hi = 2¬∑‚Ñì_hi; }
	while ‚Ñì_lo+1 < ‚Ñì_hi{
		‚Ñì_mid := (‚Ñì_lo+‚Ñì_hi) div 2;
		if ok(2¬∑‚Ñì_mid+1){
			‚Ñì_hi = ‚Ñì_mid;
		}else{
			‚Ñì_lo = ‚Ñì_mid;
		}
	}
	return 2¬∑‚Ñì_hi+1;
}

n:=6;
def main(){
	Œ¥:=0.0005;
	L:=ylc_choose_L(2/2^n,Œ¥);
	return ylc_fixed_point((x:uint[n])lifted‚áíx=42|x=17,L,Œ¥);
}

// def main() ‚áí ylc_staged_heralded((x:uint[6])lifted‚áíx=42|x=17);
