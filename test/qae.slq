// skipped

import qpe;

def makeQ[a:type](const markGood: a â†’mfree a, const markA: aâ†’mfree a)(u:a){
	u := markGood(u);
	u := markA(u);
	phase(Ï€);
	return u;
}

def makeMarkA[m:!â„•,n:!â„•](const A: ğ”¹^m â†’mfree ğ”¹^n)(u:ğ”¹^n){
	with A(u):=u{
		if u=vector(m,0){
			phase(Ï€);
		}
	}
	return u;
}

def estimateAmplitude[m:!â„•][a:qtype](const Q: a â†’mfree a, u: a){
	Qp := [p:uint[m]](u:a){
		p:=dup(p); // TODO: fix and remove
		for i in 0..m{
			if p[i]{
				for k in 0..2^i{
					u:=Q(u);
				}
			}
		}
		return u;
	};
	return sin(Ï€Â·(estimatePhase[m](Qp,u) as !â„¤)/2^m)^2;
}

def makeBernoulliQ[p:!â„](x:ğ”¹)â‡’rotY(2Â·asin(sqrt(p)),x);

def main(){
	A:=makeBernoulliQ[0.2];
	markGood:=(x:ğ”¹){ if x { phase(Ï€); } return x; };
	markA:=(x:ğ”¹){ (x,):=makeMarkA((x:ğ”¹^1){ with (x,):=x do x:=A(x); return x; })(x,); return x; };
	Q:=makeQ(markGood,markA);
	return estimateAmplitude[8](Q,A(0));
}

