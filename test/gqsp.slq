// GQSP (motlag-wiebe)
// https://arxiv.org/abs/2308.01501

C := ‚Ñù√ó‚Ñù; // manual complex number arithmetic (TODO: replace with built-in ‚ÑÇ)
def cadd(a:!C,b:!C):!C‚áí(a[0]+b[0],a[1]+b[1]);
def csub(a:!C,b:!C):!C‚áí(a[0]-b[0],a[1]-b[1]);
def cscale(s:!‚Ñù,a:!C):!C‚áí(s¬∑a[0],s¬∑a[1]);
def conj(a:!C):!C‚áí(a[0],-a[1]);

def cmul(a:!C,b:!C):!C‚áí(a[0]¬∑b[0]-a[1]¬∑b[1],a[0]¬∑b[1]+a[1]¬∑b[0]);

def cabs_sq(a:!C):!‚Ñù‚áía[0]^2+a[1]^2;
def cabs(z: !C):!‚Ñù‚áísqrt(cabs_sq(z));
def carg(z: !C):!‚Ñù‚áíatan2(z[1],z[0]);

def cinv(z:!C):!C{
    denom:=cabs_sq(z);
    assert(denom>0);
    return (z[0]/denom, -z[1]/denom);
}

def cis(Œ∏:!‚Ñù):!C‚áí(cos(Œ∏),sin(Œ∏));
def cexp(x:!C)‚áícscale(exp(x[0]),cis(x[1]));
def clog(x:!C)‚áí(log(cabs(x)),carg(x));

def fft[N:!‚Ñï](xs:!C^N):!C^N {
    if N=1 { return xs; }
    assert(N%2=0);
    xs_e:=vector(N div 2,(0,0));
    xs_o:=vector(N div 2,(0,0));
    for j in 0..N div 2{
        xs_e[j]=xs[2¬∑j];
        xs_o[j]=xs[2¬∑j+1];
    }
    ys_e:=fft(xs_e);
    ys_o:=fft(xs_o);
    ys:=vector(N,(0,0));
    for k in 0..N div 2{
        t:=cmul(cis(-2¬∑œÄ¬∑k/N),ys_o[k]);
        ys[k]=cadd(ys_e[k],t);
        ys[k+N div 2]=csub(ys_e[k],t);
    }
    return ys;
}
def ifft[N:!‚Ñï](ys:!C^N):!C^N {
	for i in 0..N{ ys[i]:=conj(ys[i]); }
	xs:=fft(ys);
	for i in 0..N{ xs[i]:=cscale(1/N,conj(xs[i])); }
	return xs;
}

def poly_eval[d:!‚Ñï](coeffs:!C^(d+1))(x:!C):!C{
	r:=coeffs[d];
	for i in (d..-1..0]{
		r=cadd(cmul(r,x),coeffs[i]);
	}
	return r;
}

def pad[m:!‚Ñï][a:type,n:!‚Ñï](xs:a^n,const x:a):a^m‚áíxs~vector(m sub n,x);

// berntson-s√ºnderhauf
// https://arxiv.org/abs/2406.04246
def thm3_N‚ÇÄ(Œµ:!‚Ñù,Œ¥:!‚Ñù,d:!‚Ñï):!‚Ñï{
	assert(0<Œ¥‚àßŒ¥<1‚àß0<Œµ‚àßŒµ<1);
	rŒ¥:=(1/(1-Œ¥))^(1/d);
	N‚ÇÄ:=ceil(2/log(rŒ¥)¬∑log(8¬∑-log(Œ¥)/(rŒ¥-1)/Œµ)) coerce !‚Ñï;
	return ceil(N‚ÇÄ) coerce !‚Ñï;
}
def heuristic_N‚ÇÄ(Œµ:!‚Ñù,Œ¥:!‚Ñù,d:!‚Ñï):!‚Ñï{
	rŒ¥m1:=expm1(-log1p(-Œ¥)/d);
	N‚ÇÄ:=ceil(2¬∑d/-log1p(-Œ¥)¬∑log(8¬∑-log(Œ¥)/(Œµ¬∑rŒ¥m1))) coerce !‚Ñï;
	return ceil(N‚ÇÄ¬∑Œ¥) coerce !‚Ñï; // seems good enough?
}
def complement_alg1[d:!‚Ñï](p:!C^(d+1),N:!‚Ñï):!C^(d+1){
	ps:=fft(pad[N](p,(0,0)));
	‚Ñì:=vector(N,(0,0));
    for j in 0..N { ‚Ñì[j]=(log(1-cabs_sq(ps[j])),0); }
    ‚Ñì:=ifft(‚Ñì);
	log_qs:=fft(pad[N]([cscale(1/2,‚Ñì[0])]~‚Ñì[1..N div 2+1],(0,0)));
    qs:=vector(N,(0,0));
    for j in 0..N { qs[j]=cexp(log_qs[j]); }
	return ifft(qs)[0..d+1];
}

def complement_alg2[d:!‚Ñï](p:!C^(d+1),Œµ:!‚Ñù,N:!‚Ñï):!C^(d+1){
	for i in 0..d+1{ p[i]:=cscale(1-Œµ/4,p[i]); }
	return complement_alg1[d](p,N);
}

def complement[d:!‚Ñï](p:!C^(d+1),Œµ:!‚Ñù):!C^(d+1){
	//N‚ÇÄ:=thm3_N‚ÇÄ(Œµ/4,Œµ/(5¬∑(d+1)),d);
	N‚ÇÄ:=heuristic_N‚ÇÄ(Œµ/4,Œµ/(5¬∑(d+1)),d);
	N:=2^(ceil(log‚ÇÇ(max(N‚ÇÄ,d+1))) coerce !‚Ñï);
	return complement_alg2[d](p,Œµ,N);
}

def is_complement[N:!‚Ñï][d:!‚Ñï](p:!C^(d+1),q:!C^(d+1),Œµ:!‚Ñù){
	assert(N‚â•d+1‚àß(N&(N-1))=0);
	ps:=fft(pad[N](p,(0,0)));
	qs:=fft(pad[N](q,(0,0)));
	ok:=1;
	for j in 0..N{
		ok&=abs(cabs_sq(ps[j])+cabs_sq(qs[j])-1)<Œµ;
	}
	return ok;
}

def gqsp_apply_Rdag[d:!‚Ñï](
    Œ∏: !‚Ñù,
    œÜ: !‚Ñù,
	Œª_: !‚Ñù,
    P: !C^(d+1),
    Q: !C^(d+1)
):!C^(d+1)√ó!C^(d+1){
	(c,s):=(cos(Œ∏),sin(Œ∏));
    ac:=conj(cscale(c,cis(Œª_+œÜ)));
    bc:=conj(cscale(s,cis(œÜ)));
    cc:=conj(cscale(s,cis(Œª_)));
    dc:=conj((-c,0));

	Pp:=vector(d+1,(0,0));
    Qp:=vector(d+1,(0,0));
    for k in 0..d+1 {
        Pp[k]=cadd(cmul(ac, P[k]), cmul(cc, Q[k]));
        Qp[k]=cadd(cmul(bc, P[k]), cmul(dc, Q[k]));
    }
    return (Pp,Qp);
}

def gqsp_compute_angles[d:!‚Ñï](
    P:!C^(d+1),
    Q:!C^(d+1),
):!‚Ñù^(d+1)√ó!‚Ñù^(d+1)√ó!‚Ñù{
    Œ∏d:=atan2(cabs(Q[d]),cabs(P[d]));
    œÜd:=carg(P[d])-carg(Q[d]);
    if d=0 {
        Œª_:=carg(Q[d]);
        return ([Œ∏d],[œÜd],Œª_) coerce !‚Ñù^(d+1)√ó!‚Ñù^(d+1)√ó!‚Ñù;
    }
    (Pp,Qp):=gqsp_apply_Rdag[d](Œ∏d,œÜd,0,P,Q);
    (Œ∏_small,œÜ_small,Œª_):=gqsp_compute_angles[d sub 1](Pp[1..d+1],Qp[0..d]);
	return (Œ∏_small~[Œ∏d],œÜ_small~[œÜd],Œª_);
}

def R(Œ∏:!‚Ñù,œÜ:!‚Ñù,Œª_:!‚Ñù)(anc:ùîπ){
    phase((œÄ+Œª_+œÜ)/2);
    anc:=rotZ(œÄ-Œª_,anc);
    anc:=rotY(2¬∑Œ∏,anc);
    anc:=rotZ(-œÜ,anc);
    return anc;
}

def gqsp[d:!‚Ñï](
    Œ∏s:!‚Ñù^(d+1),
    œÜs:!‚Ñù^(d+1),
    Œª_:!‚Ñù,
)[a:qtype](const f: a ‚Üímfree a)(cand: a):ùîπ√óa{
    anc:=R(Œ∏s[0],œÜs[0],Œª_)(0:ùîπ);
    for j in 1..d+1 {
        if anc=0{ cand:=f(cand); }
        anc:=R(Œ∏s[j],œÜs[j],0)(anc);
    }
    return (anc,cand);
}

def main(){
	p:=((0.07,0),(0.35,0),(0.35,0),(0.2,0));
	q:=complement[3](p,1e-8);
	print(q);
	assert(is_complement[128][3](p,q,1e-8));
	angles:=gqsp_compute_angles[3](p,q);
	z:=cis(-1/4);
	print(poly_eval[3](p)(z));
	print(poly_eval[3](q)(z));
	return gqsp[3](angles)((x:ùîπ)‚áírotZ(1/2,x))(0:ùîπ);
}
