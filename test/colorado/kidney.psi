// skipped: too slow
// Colorado PLDI'13: Example: Estimating Kidney Disease Risk in Adults

def estimateLogEGFR(logScr,age,isFemale,isAA){
    k := 0;
    alpha := 0;
    f := 0;
    if isFemale{
        k = -357/1000;
        alpha = -329/1000;
    }else{
        k = -105/1000;
        alpha = -411/1000;
    }
    
    
    f = if logScr < k {
        alpha * (logScr - k);
    }else{
        -1209/1000 * (logScr - k);
    };
    f = f - 7*age/1000;
    
    if isFemale { f += 17/1000; }
    if isAA { f += 148/1000; }
    return f; // expected: (∫dξ₁(∫dξ₂(∫dξ₃((∫dξ₄[-1000·f+-7·ξ₄+148≠0]·[-1000·f+-7·ξ₄+148≤0]·q(-1000·f·⅟411+-7·ξ₄·⅟411+148·⅟411+ξ₁,ξ₄,ξ₃,ξ₂))·200000·δ(0)[-200·ξ₁+-21]·⅟411+(∫dξ₄[-148+1000·f+7·ξ₄≤0]·q(-1000·f·⅟1209+-7·ξ₄·⅟1209+148·⅟1209+ξ₁,ξ₄,ξ₃,ξ₂))·200000·δ(0)[-200·ξ₁+-21]·⅟1209)·[ξ₃=0]+∫dξ₃((∫dξ₄[-1000·f+-7·ξ₄+165≠0]·[-1000·f+-7·ξ₄+165≤0]·q(-1000·f·⅟329+-ξ₄·⅟47+165·⅟329+ξ₁,ξ₄,ξ₃,ξ₂))·1000000·δ(0)[-1000·ξ₁+-357]·⅟329+(∫dξ₄[-165+1000·f+7·ξ₄≤0]·q(-1000·f·⅟1209+-7·ξ₄·⅟1209+55·⅟403+ξ₁,ξ₄,ξ₃,ξ₂))·1000000·δ(0)[-1000·ξ₁+-357]·⅟1209)·[ξ₃≠0])·[ξ₂≠0]+∫dξ₂(∫dξ₃((∫dξ₄[-1000·f+-7·ξ₄+17≠0]·[-1000·f+-7·ξ₄+17≤0]·q(-1000·f·⅟329+-ξ₄·⅟47+17·⅟329+ξ₁,ξ₄,ξ₃,ξ₂))·1000000·δ(0)[-1000·ξ₁+-357]·⅟329+(∫dξ₄[-17+1000·f+7·ξ₄≤0]·q(-1000·f·⅟1209+-7·ξ₄·⅟1209+17·⅟1209+ξ₁,ξ₄,ξ₃,ξ₂))·1000000·δ(0)[-1000·ξ₁+-357]·⅟1209)·[ξ₃≠0]+∫dξ₃((∫dξ₄[-1000·f+-7·ξ₄≠0]·[-1000·f+-7·ξ₄≤0]·q(-1000·f·⅟411+-7·ξ₄·⅟411+ξ₁,ξ₄,ξ₃,ξ₂))·200000·δ(0)[-200·ξ₁+-21]·⅟411+(∫dξ₄[1000·f+7·ξ₄≤0]·q(-1000·f·⅟1209+-7·ξ₄·⅟1209+ξ₁,ξ₄,ξ₃,ξ₂))·200000·δ(0)[-200·ξ₁+-21]·⅟1209)·[ξ₃=0])·[ξ₂=0]))·[∫dξ₁∫dξ₂(∫dξ₃(∫dξ₄((∫dξ₅[-1000·ξ₁+-7·ξ₅+148≠0]·[-1000·ξ₁+-7·ξ₅+148≤0]·q(-1000·ξ₁·⅟411+-7·ξ₅·⅟411+148·⅟411+ξ₂,ξ₅,ξ₄,ξ₃))·200000·δ(0)[-200·ξ₂+-21]·⅟411+(∫dξ₅[-148+1000·ξ₁+7·ξ₅≤0]·q(-1000·ξ₁·⅟1209+-7·ξ₅·⅟1209+148·⅟1209+ξ₂,ξ₅,ξ₄,ξ₃))·200000·δ(0)[-200·ξ₂+-21]·⅟1209)·[ξ₄=0]+∫dξ₄((∫dξ₅[-1000·ξ₁+-7·ξ₅+165≠0]·[-1000·ξ₁+-7·ξ₅+165≤0]·q(-1000·ξ₁·⅟329+-ξ₅·⅟47+165·⅟329+ξ₂,ξ₅,ξ₄,ξ₃))·1000000·δ(0)[-1000·ξ₂+-357]·⅟329+(∫dξ₅[-165+1000·ξ₁+7·ξ₅≤0]·q(-1000·ξ₁·⅟1209+-7·ξ₅·⅟1209+55·⅟403+ξ₂,ξ₅,ξ₄,ξ₃))·1000000·δ(0)[-1000·ξ₂+-357]·⅟1209)·[ξ₄≠0])·[ξ₃≠0]+∫dξ₃(∫dξ₄((∫dξ₅[-1000·ξ₁+-7·ξ₅+17≠0]·[-1000·ξ₁+-7·ξ₅+17≤0]·q(-1000·ξ₁·⅟329+-ξ₅·⅟47+17·⅟329+ξ₂,ξ₅,ξ₄,ξ₃))·1000000·δ(0)[-1000·ξ₂+-357]·⅟329+(∫dξ₅[-17+1000·ξ₁+7·ξ₅≤0]·q(-1000·ξ₁·⅟1209+-7·ξ₅·⅟1209+17·⅟1209+ξ₂,ξ₅,ξ₄,ξ₃))·1000000·δ(0)[-1000·ξ₂+-357]·⅟1209)·[ξ₄≠0]+∫dξ₄((∫dξ₅[-1000·ξ₁+-7·ξ₅≠0]·[-1000·ξ₁+-7·ξ₅≤0]·q(-1000·ξ₁·⅟411+-7·ξ₅·⅟411+ξ₂,ξ₅,ξ₄,ξ₃))·200000·δ(0)[-200·ξ₂+-21]·⅟411+(∫dξ₅[1000·ξ₁+7·ξ₅≤0]·q(-1000·ξ₁·⅟1209+-7·ξ₅·⅟1209+ξ₂,ξ₅,ξ₄,ξ₃))·200000·δ(0)[-200·ξ₂+-21]·⅟1209)·[ξ₄=0])·[ξ₃=0])≠0]·⅟(∫dξ₁∫dξ₂(∫dξ₃(∫dξ₄((∫dξ₅[-1000·ξ₁+-7·ξ₅+148≠0]·[-1000·ξ₁+-7·ξ₅+148≤0]·q(-1000·ξ₁·⅟411+-7·ξ₅·⅟411+148·⅟411+ξ₂,ξ₅,ξ₄,ξ₃))·200000·δ(0)[-200·ξ₂+-21]·⅟411+(∫dξ₅[-148+1000·ξ₁+7·ξ₅≤0]·q(-1000·ξ₁·⅟1209+-7·ξ₅·⅟1209+148·⅟1209+ξ₂,ξ₅,ξ₄,ξ₃))·200000·δ(0)[-200·ξ₂+-21]·⅟1209)·[ξ₄=0]+∫dξ₄((∫dξ₅[-1000·ξ₁+-7·ξ₅+165≠0]·[-1000·ξ₁+-7·ξ₅+165≤0]·q(-1000·ξ₁·⅟329+-ξ₅·⅟47+165·⅟329+ξ₂,ξ₅,ξ₄,ξ₃))·1000000·δ(0)[-1000·ξ₂+-357]·⅟329+(∫dξ₅[-165+1000·ξ₁+7·ξ₅≤0]·q(-1000·ξ₁·⅟1209+-7·ξ₅·⅟1209+55·⅟403+ξ₂,ξ₅,ξ₄,ξ₃))·1000000·δ(0)[-1000·ξ₂+-357]·⅟1209)·[ξ₄≠0])·[ξ₃≠0]+∫dξ₃(∫dξ₄((∫dξ₅[-1000·ξ₁+-7·ξ₅+17≠0]·[-1000·ξ₁+-7·ξ₅+17≤0]·q(-1000·ξ₁·⅟329+-ξ₅·⅟47+17·⅟329+ξ₂,ξ₅,ξ₄,ξ₃))·1000000·δ(0)[-1000·ξ₂+-357]·⅟329+(∫dξ₅[-17+1000·ξ₁+7·ξ₅≤0]·q(-1000·ξ₁·⅟1209+-7·ξ₅·⅟1209+17·⅟1209+ξ₂,ξ₅,ξ₄,ξ₃))·1000000·δ(0)[-1000·ξ₂+-357]·⅟1209)·[ξ₄≠0]+∫dξ₄((∫dξ₅[-1000·ξ₁+-7·ξ₅≠0]·[-1000·ξ₁+-7·ξ₅≤0]·q(-1000·ξ₁·⅟411+-7·ξ₅·⅟411+ξ₂,ξ₅,ξ₄,ξ₃))·200000·δ(0)[-200·ξ₂+-21]·⅟411+(∫dξ₅[1000·ξ₁+7·ξ₅≤0]·q(-1000·ξ₁·⅟1209+-7·ξ₅·⅟1209+ξ₂,ξ₅,ξ₄,ξ₃))·200000·δ(0)[-200·ξ₂+-21]·⅟1209)·[ξ₄=0])·[ξ₃=0]))
}

def compareWithNoise(logScr,age,isFemale,isAA){
    f1 := estimateLogEGFR(logScr,age,isFemale,isAA);
    logScr += uniform(-1/10,1/10);
    age += uniformInt(-1,1);
    if flip(1/100){
        isFemale = !isFemale;
    }
    if flip(1/100){
        isAA = !isAA;
    }
    f2 := estimateLogEGFR(logScr,age,isFemale,isAA);
    r1 := f1 - f2 >= 0.1;
    r2 := f2 - f1 >= 0.1;
    return (r1,r2);
}

def main(){
    // TODO: check whether this makes any sense 
    logScr:=467/100;
    age:=30;
    isFemale:=1;
    isAA:=1;
    return compareWithNoise(logScr,age,isFemale,isAA);
}
